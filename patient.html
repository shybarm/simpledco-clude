// patient.js — Patient file: details, visits, invoices, and send via Edge Function
const sb = window.getSupabaseClient();

function $(id){ return document.getElementById(id); }

function qparam(name){
  const u = new URL(window.location.href);
  return u.searchParams.get(name);
}

function money(n){
  const x = Number(n || 0);
  return x.toFixed(2);
}

function setActiveTab(tab){
  document.querySelectorAll(".tab").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
  document.querySelectorAll(".panel").forEach(p => p.classList.toggle("active", p.id === `panel-${tab}`));
}

async function requireAuth(){
  const { data } = await sb.auth.getSession();
  if (!data?.session){
    window.location.href = "./admin.html";
    return null;
  }
  return data.session;
}

async function logout(){
  await sb.auth.signOut();
  window.location.href = "./admin.html";
}

let patientId = null;
let patient = null;

async function loadPatient(){
  const { data, error } = await sb.from("patients").select("*").eq("id", patientId).single();
  if (error) throw error;
  patient = data;

  $("patientIdLabel").textContent = `patient_id: ${patient.id}`;
  $("fullNameInput").value = patient.full_name || "";
  $("emailInput").value = patient.email || "";
  $("phoneInput").value = patient.phone || "";
  $("patientMeta").textContent = `נוצר: ${new Date(patient.created_at).toLocaleString("he-IL")}`;
}

async function savePatient(){
  const full_name = ($("fullNameInput").value || "").trim();
  const email = ($("emailInput").value || "").trim();
  const phone = ($("phoneInput").value || "").trim();

  const { error } = await sb.from("patients").update({ full_name, email, phone }).eq("id", patientId);
  if (error) throw error;
  await loadPatient();
  alert("✅ נשמר");
}

async function loadAppointments(){
  const { data, error } = await sb
    .from("appointments")
    .select("*")
    .eq("patient_id", patientId)
    .order("created_at", { ascending: false });

  if (error) throw error;

  const wrap = $("appointmentsList");
  wrap.innerHTML = "";

  if (!data?.length){
    wrap.innerHTML = `<div class="muted">אין תורים מקושרים למטופל.</div>`;
    return;
  }

  data.forEach(a => {
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div>
        <strong>${a.service || ""}</strong>
        <small>נוצר: ${new Date(a.created_at).toLocaleString("he-IL")}</small>
        <small>תאריך/שעה: ${a.date || ""} ${a.time || ""}</small>
        <small>סטטוס: ${a.status || ""}</small>
      </div>
      <div class="actions">
        <button class="btn-outline" data-appt="${a.id}" type="button">קשר לביקור</button>
      </div>
    `;
    div.querySelector("button").addEventListener("click", () => {
      // Optional: set default appointment_id when creating next visit
      window.__LINK_APPOINTMENT_ID__ = a.id;
      alert("✅ התור יקושר לביקור הבא שתשמור.");
    });
    wrap.appendChild(div);
  });
}

async function loadVisits(){
  const { data, error } = await sb
    .from("visits")
    .select("*")
    .eq("patient_id", patientId)
    .order("created_at", { ascending: false });

  if (error) throw error;

  const wrap = $("visitsList");
  wrap.innerHTML = "";

  if (!data?.length){
    wrap.innerHTML = `<div class="muted">אין ביקורים עדיין.</div>`;
    return;
  }

  data.forEach(v => {
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div>
        <strong>${v.visit_date || ""}</strong>
        <small><strong>סיכום:</strong> ${(v.summary || "").replace(/</g,"&lt;")}</small>
        <small><strong>הערות:</strong> ${(v.doctor_notes || "").replace(/</g,"&lt;")}</small>
      </div>
      <div class="actions">
        <button class="btn-outline" data-visit="${v.id}" type="button">צור חשבונית לביקור</button>
      </div>
    `;
    div.querySelector("button").addEventListener("click", async () => {
      await createInvoice({ visit_id: v.id });
      setActiveTab("invoices");
    });
    wrap.appendChild(div);
  });
}

async function createVisit(){
  const visit_date = $("visitDateInput").value || new Date().toISOString().slice(0,10);
  const summary = ($("visitSummaryInput").value || "").trim();
  const doctor_notes = ($("visitNotesInput").value || "").trim();
  const appointment_id = window.__LINK_APPOINTMENT_ID__ || null;

  const { data, error } = await sb
    .from("visits")
    .insert([{
      patient_id: patientId,
      appointment_id,
      visit_date,
      summary,
      doctor_notes
    }])
    .select("*")
    .single();

  if (error) throw error;

  window.__LINK_APPOINTMENT_ID__ = null;
  $("visitSummaryInput").value = "";
  $("visitNotesInput").value = "";

  alert("✅ ביקור נשמר");
  await loadVisits();
}

function addItemRow(item = { description:"", qty:1, unit_price:0 }){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="desc" type="text" value="${item.description || ""}"></td>
    <td><input class="qty" type="number" min="0" step="1" value="${Number(item.qty || 1)}"></td>
    <td><input class="price" type="number" min="0" step="0.01" value="${Number(item.unit_price || 0)}"></td>
    <td class="line_total">${money((item.qty||1)*(item.unit_price||0))}</td>
  `;
  $("itemsBody").appendChild(tr);

  const recalc = () => {
    const qty = Number(tr.querySelector(".qty").value || 0);
    const price = Number(tr.querySelector(".price").value || 0);
    tr.querySelector(".line_total").textContent = money(qty * price);
    recalcTotals();
  };

  tr.querySelector(".qty").addEventListener("input", recalc);
  tr.querySelector(".price").addEventListener("input", recalc);

  recalcTotals();
}

function recalcTotals(){
  let subtotal = 0;
  document.querySelectorAll("#itemsBody tr").forEach(tr => {
    subtotal += Number(tr.querySelector(".line_total").textContent || 0);
  });
  $("subTotalLabel").textContent = money(subtotal);
  $("totalLabel").textContent = money(subtotal);
}

async function createInvoice({ visit_id = null } = {}){
  const toEmail = ($("invoiceToEmailInput").value || "").trim() || (patient?.email || "");

  // 1) create invoice header (invoice_number auto by trigger)
  const { data: inv, error: invErr } = await sb
    .from("invoices")
    .insert([{
      patient_id: patientId,
      visit_id,
      status: "draft",
      currency: "ILS",
      sent_to_email: toEmail || null
    }])
    .select("*")
    .single();

  if (invErr) throw invErr;

  // 2) insert items
  const rows = [];
  document.querySelectorAll("#itemsBody tr").forEach(tr => {
    const description = (tr.querySelector(".desc").value || "").trim();
    const qty = Number(tr.querySelector(".qty").value || 0);
    const unit_price = Number(tr.querySelector(".price").value || 0);
    if (!description) return;
    rows.push({
      invoice_id: inv.id,
      description,
      qty,
      unit_price,
      line_total: qty * unit_price
    });
  });

  if (!rows.length){
    // create at least one default item if user forgot
    rows.push({
      invoice_id: inv.id,
      description: "ביקור רפואי",
      qty: 1,
      unit_price: 0,
      line_total: 0
    });
  }

  const { error: itemsErr } = await sb.from("invoice_items").insert(rows);
  if (itemsErr) throw itemsErr;

  // Totals will auto-recalc via trigger
  $("itemsBody").innerHTML = "";
  addItemRow({ description:"ביקור רפואי", qty:1, unit_price:0 });

  alert(`✅ נוצרה חשבונית: ${inv.invoice_number || "(ממתין)"}`);
  await loadInvoices();
}

async function loadInvoices(){
  const { data, error } = await sb
    .from("invoices")
    .select("*")
    .eq("patient_id", patientId)
    .order("created_at", { ascending: false });

  if (error) throw error;

  const wrap = $("invoicesList");
  wrap.innerHTML = "";

  if (!data?.length){
    wrap.innerHTML = `<div class="muted">אין חשבוניות עדיין.</div>`;
    return;
  }

  data.forEach(inv => {
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div>
        <strong>${inv.invoice_number || "INV-..."}</strong>
        <small>סטטוס: ${inv.status}</small>
        <small>סה״כ: ${money(inv.total)} ${inv.currency || "ILS"}</small>
        <small>נוצר: ${new Date(inv.created_at).toLocaleString("he-IL")}</small>
        <small>נשלח ל: ${inv.sent_to_email || "-"}</small>
      </div>
      <div class="actions">
        <button class="btn-secondary" data-send="${inv.id}" type="button">שלח במייל</button>
        <button class="btn-outline" data-paid="${inv.id}" type="button">סמן כשולם</button>
      </div>
    `;

    div.querySelector("[data-send]").addEventListener("click", () => sendInvoice(inv.id));
    div.querySelector("[data-paid]").addEventListener("click", () => markPaid(inv.id));

    wrap.appendChild(div);
  });
}

async function markPaid(invoiceId){
  const { error } = await sb.from("invoices").update({ status:"paid" }).eq("id", invoiceId);
  if (error) throw error;
  await loadInvoices();
  alert("✅ עודכן ל'שולם'");
}

async function sendInvoice(invoiceId){
  // Calls Edge Function: /functions/v1/send-invoice
  // Requires RESEND secrets configured in Supabase
  const { data, error } = await sb.functions.invoke("send-invoice", {
    body: { invoice_id: invoiceId }
  });

  if (error){
    console.error(error);
    alert("שליחה נכשלה: " + (error.message || "error"));
    return;
  }

  alert("✅ נשלח במייל");
  await loadInvoices();
}

async function refreshAll(){
  await loadPatient();
  await loadAppointments();
  await loadVisits();
  await loadInvoices();
}

document.addEventListener("DOMContentLoaded", async () => {
  const ok = await requireAuth();
  if (!ok) return;

  patientId = qparam("patient_id");
  if (!patientId){
    alert("Missing patient_id");
    window.location.href = "./admin.html";
    return;
  }

  $("logoutLink").addEventListener("click", (e) => { e.preventDefault(); logout(); });
  $("refreshBtn").addEventListener("click", refreshAll);

  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
  });

  $("savePatientBtn").addEventListener("click", () => savePatient().catch(e => alert(e.message)));
  $("createVisitBtn").addEventListener("click", () => createVisit().catch(e => alert(e.message)));

  $("addItemBtn").addEventListener("click", () => addItemRow());
  $("createInvoiceBtn").addEventListener("click", () => createInvoice().catch(e => alert(e.message)));

  // defaults
  $("visitDateInput").value = new Date().toISOString().slice(0,10);
  addItemRow({ description:"ביקור רפואי", qty:1, unit_price:0 });

  await refreshAll();
});
